<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "mybatis-3-mapper.dtd">
<mapper namespace="sellerweb.counsel">

    <select id="counselList" resultType="DevMap" parameterType="DevMap">
        select T.CALL_ST_CD,
        t1.MNT_CARR,
        t1.PN_REG_DIS,
        (select PN_MNT_RT_NM FROM TBL010 tt1 where tt1.PN_MNT_RT_NO = t1.PN_MNT_RT_NO) as PN_MNT_RT_NM,
        t1.PN_MNT_RT_NO,
        t1.PN_MDL_NO,
        (select PN_MDL_NM FROM TBL011 tt2 where tt2.PN_MDL_NO = t1.PN_MDL_NO) as PN_MDL_NM,
        t1.PN_STOR,
        (select PN_MSRP FROM TBL011 tt4 where tt4.PN_MDL_NO = t1.PN_MDL_NO) as PN_MSRP,
        (SELECT MBR_NM FROM TBL001 tt3 where tt3.CL_MBR_ID = t1.CL_MBR_ID) as CL_MBR_NM,
        DATE_FORMAT(T.VISIT_DT, '%Y-%m-%d %H:%i') as VISIT_DT,
        T.MBR_PN_NO,
        T.OLD_OFCL_SUBSD,
        T.OLD_EXT_SUBSD_DV,
        T.OLD_EXT_SUBSD_RT,
        T.OLD_EXT_SERV_YN,
        T.CALL_NO,
        T.BN_MBR_ID,
        (SELECT MBR_NM FROM TBL002 tt5 WHERE tt5.BN_MBR_ID = T.BN_MBR_ID) as MBR_NM,
        DATE_FORMAT(T.INP_DT, '%Y-%m-%d %H:%i') as INP_DT
        from TBL008 T left join TBL006 t1 on T.DEAL_NO = t1.DEAL_NO
        where T.BN_NO = #{bnNo}
        <if test='callStCd != null and !callStCd.equals("all")'>
            and T.CALL_ST_CD = #{callStCd}
        </if>
        <if test='mntCarr != null and !mntCarr.equals("all")'>
            and t1.MNT_CARR = #{mntCarr}
        </if>
        <if test='counselType != null and !counselType.equals("all")'>
            and t1.PN_REG_DIS = #{counselType}
        </if>
        <if test='clientNm != "" and clientNm != null'>
            and (SELECT MBR_NM FROM TBL001 tt5 where tt5.CL_MBR_ID = t1.CL_MBR_ID) LIKE CONCAT('%', #{clientNm}, '%')
        </if>
        <if test='bnMbr !="all"'>
            and T.BN_MBR_ID = #{bnMbr}
        </if>

    </select>

    <select id="currPolicy" parameterType="DevMap" resultType="Devmap">
        select (select PN_MSRP FROM TBL011 tt1 where tt1.PN_MDL_NO = T.PN_MDL_NO) as PN_MSRP,
        T.PN_OFCL_SUBSD,
        T.PN_EXT_SUBSD_DV,
        T.PN_EXT_SUBSD_RT,
        T.PN_EXT_SERV_YN
        <choose>
            <when test='pnRegDis == "A"'>
                from `TBL007-A` T
            </when>
            <when test='pnRegDis == "B"'>
                from `TBL007-B` T
            </when>
            <when test='pnRegDis == "C"'>
                from `TBL007-C` T
            </when>
        </choose>
        where PN_MDL_NO = #{pnMdlNo}
        and PN_STOR = #{pnStor}
        and PN_MNT_RT_NO = #{pnMntRtNo}
        and BN_NO = #{bnNo}
    </select>
    
    <select id="bnMbrList" parameterType="DevMap" resultType="DevMap">
        SELECT BN_MBR_ID, MBR_NM
          FROM TBL002 t
         WHERE BN_NO = #{bnNo}
            AND ACTV_YN  = 'Y'
    </select>

</mapper>