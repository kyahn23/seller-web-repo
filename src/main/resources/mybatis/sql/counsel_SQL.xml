<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "mybatis-3-mapper.dtd">
<mapper namespace="sellerweb.counsel">

    <select id="counselList" resultType="DevMap" parameterType="DevMap">
        select T.CALL_ST_CD,
        t1.MNT_CARR,
        t1.PN_REG_DIS,
        (select PN_MNT_RT_NM FROM TBL010 tt1 where tt1.PN_MNT_RT_NO = t1.PN_MNT_RT_NO) as PN_MNT_RT_NM,
        (select PN_NET_TYPE FROM TBL010 tt1 where tt1.PN_MNT_RT_NO = t1.PN_MNT_RT_NO) as PN_NET_TYPE,
        t1.PN_MNT_RT_NO,
        t1.PN_MDL_NO,
        (select PN_MDL_NM FROM TBL011 tt2 where tt2.PN_MDL_NO = t1.PN_MDL_NO) as PN_MDL_NM,
        t1.PN_STOR,
        (select PN_MSRP FROM TBL011 tt4 where tt4.PN_MDL_NO = t1.PN_MDL_NO) as PN_MSRP,
        (SELECT MBR_NM FROM TBL001 tt3 where tt3.CL_MBR_ID = t1.CL_MBR_ID) as CL_MBR_NM,
        (SELECT PN_MKR FROM TBL011 pnmkr where pnmkr.PN_MDL_NO = t1.PN_MDL_NO) as PN_MKR,
        DATE_FORMAT(T.VISIT_DT, '%Y-%m-%d %H:%i') as VISIT_DT,
        t1.DEAL_REQ,
        T.MBR_PN_NO,
        T.OLD_OFCL_SUBSD,
        T.OLD_EXT_SUBSD_DV,
        T.OLD_EXT_SUBSD_RT,
        T.OLD_EXT_SERV_YN,
        T.CALL_NO,
        T.CALL_CONT,
        T.BN_MBR_ID,
        (SELECT MBR_NM FROM TBL002 tt5 WHERE tt5.BN_MBR_ID = T.BN_MBR_ID) as MBR_NM,
        DATE_FORMAT(T.INP_DT, '%Y-%m-%d %H:%i') as INP_DT,
        DATE_FORMAT(T.AMD_DT, '%Y-%m-%d %H:%i') as AMD_DT
        from TBL008 T left join TBL006 t1 on T.DEAL_NO = t1.DEAL_NO
        where T.BN_NO = #{bnNo}
        <if test='callStCd != null and !callStCd.equals("all")'>
            and T.CALL_ST_CD = #{callStCd}
            <if test='visitDt != null'>
                and DATE_FORMAT(T.VISIT_DT, '%Y-%m-%d') = #{visitDt}
            </if>
        </if>
        <if test='mntCarr != null and !mntCarr.equals("all")'>
            and t1.MNT_CARR = #{mntCarr}
        </if>
        <if test='counselType != null and !counselType.equals("all")'>
            and t1.PN_REG_DIS = #{counselType}
        </if>
        <if test='clientNm != "" and clientNm != null'>
            and (SELECT MBR_NM FROM TBL001 tt5 where tt5.CL_MBR_ID = t1.CL_MBR_ID) LIKE CONCAT('%', #{clientNm}, '%')
        </if>
        <if test='bnMbr !="all"'>
            and T.BN_MBR_ID = #{bnMbr}
        </if>
        <if test='searchDay != null'>
            and DATE_FORMAT(T.AMD_DT, '%Y-%m-%d') = #{searchDay}
        </if>
    </select>

    <select id="currPolicy" parameterType="DevMap" resultType="Devmap">
        select (select PN_MSRP FROM TBL011 tt1 where tt1.PN_MDL_NO = T.PN_MDL_NO) as PN_MSRP,
        T.PN_OFCL_SUBSD,
        T.PN_EXT_SUBSD_DV,
        T.PN_EXT_SUBSD_RT,
        T.PN_EXT_SERV_YN
        <choose>
            <when test='pnRegDis == "A"'>
                from `TBL007-A` T
            </when>
            <when test='pnRegDis == "B"'>
                from `TBL007-B` T
            </when>
            <when test='pnRegDis == "C"'>
                from `TBL007-C` T
            </when>
        </choose>
        where PN_MDL_NO = #{pnMdlNo}
        and PN_STOR = #{pnStor}
        and PN_MNT_RT_NO = #{pnMntRtNo}
        and BN_NO = #{bnNo}
    </select>
    
    <select id="bnMbrList" parameterType="DevMap" resultType="DevMap">
        SELECT BN_MBR_ID, MBR_NM
          FROM TBL002 t
         WHERE BN_NO = #{bnNo}
            AND ACTV_YN  = 'Y'
    </select>

    <update id="saveCounsel" parameterType="DevMap">
        update `TBL008`
        set VISIT_DT = #{visitDt},
        CALL_ST_CD = #{callStCd},
        CALL_CONT = #{csContent},
        BN_MBR_ID = #{bnMbrId},
        AMD_DT = SYSDATE()
        where BN_NO=#{bnNo}
        and CALL_NO=#{callNo}
    </update>

    <update id="modiVisitDt" parameterType="DevMap">
        update `TBL008`
        set VISIT_DT = #{visitDt},
        BN_MBR_ID = #{bnMbrId},
        AMD_DT = SYSDATE()
        where BN_NO=#{bnNo}
        and CALL_NO=#{callNo}
    </update>

    <select id="useAllCarrMntRt" parameterType="DevMap" resultType="DevMap">
        select B.MNT_USEYN_NO as MNT_USEYN_NO, /*사용여부 확인을 위한 idx*/
        A.PN_MNT_RT_NO, /*요금제 번호 */
        A.PN_MNT_RT_NM,
        A.PN_NET_TYPE,
        A.PN_CARR
        from TBL010 A left join (select * from TBL013 where BN_NO=#{bnNo}) B
        on A.PN_MNT_RT_NO = B.PN_MNT_RT_NO
        WHERE B.MNT_USEYN_NO is not null
    </select>

    <select id="allDeviceListByCarr" parameterType="DevMap" resultType="DevMap">
        SELECT * from TBL011 t
        where PN_CARR LIKE CONCAT('%', #{mntCarr}, '%') /* 기기 통신사 */
    </select>

    <update id="registerRslt" parameterType="DevMap">
        update `TBL008`
        <if test='callStCd == "T"'>
            set BN_MBR_ID = #{bnMbrId},
                CALL_ST_CD = #{callStCd},
                DEAL_CONT = #{dealCont},
                PN_REG_YN = #{pnRegYn},
                REG_CARR = #{regCarr},
                REG_MBR_PN_NO = #{regMbrPnNo},
                REG_MNT_RT_NO = #{regMntRtNo},
                REG_PN_MDL_NO = #{regPnMdlNo},
                REG_TYPE = #{regType},
        </if>
        <if test='callStCd == "E"'>
            set BN_MBR_ID = #{bnMbrId},
                CALL_ST_CD = #{callStCd},
                CNCL_CMNT = #{cnclCmnt},
                PN_REG_YN = #{pnRegYn},
        </if>
        AMD_DT = SYSDATE()
        where BN_NO=#{bnNo}
        and CALL_NO=#{callNo}
    </update>

</mapper>